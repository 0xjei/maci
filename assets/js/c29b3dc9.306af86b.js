"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[8555],{5947:(e,i,s)=>{s.r(i),s.d(i,{assets:()=>c,contentTitle:()=>t,default:()=>o,frontMatter:()=>d,metadata:()=>l,toc:()=>a});var n=s(5250),r=s(720);const d={},t="Subsidy",l={id:"solidity-docs/Subsidy",title:"Subsidy",description:"This contract is used to verify that the subsidy calculations",source:"@site/versioned_docs/version-v1.x/solidity-docs/Subsidy.md",sourceDirName:"solidity-docs",slug:"/solidity-docs/Subsidy",permalink:"/docs/solidity-docs/Subsidy",draft:!1,unlisted:!1,editUrl:"https://github.com/privacy-scaling-explorations/maci/edit/dev/website/versioned_docs/version-v1.x/solidity-docs/Subsidy.md",tags:[],version:"v1.x",frontMatter:{},sidebar:"version-1.x/mySidebar",previous:{title:"SignUpToken",permalink:"/docs/solidity-docs/SignUpToken"},next:{title:"SubsidyFactory",permalink:"/docs/solidity-docs/SubsidyFactory"}},c={},a=[{value:"rbi",id:"rbi",level:3},{value:"cbi",id:"cbi",level:3},{value:"sbCommitment",id:"sbcommitment",level:3},{value:"subsidyCommitment",id:"subsidycommitment",level:3},{value:"verifier",id:"verifier",level:3},{value:"vkRegistry",id:"vkregistry",level:3},{value:"poll",id:"poll",level:3},{value:"mp",id:"mp",level:3},{value:"ProcessingNotComplete",id:"processingnotcomplete",level:3},{value:"InvalidSubsidyProof",id:"invalidsubsidyproof",level:3},{value:"AllSubsidyCalculated",id:"allsubsidycalculated",level:3},{value:"VkNotSet",id:"vknotset",level:3},{value:"NumSignUpsTooLarge",id:"numsignupstoolarge",level:3},{value:"RbiTooLarge",id:"rbitoolarge",level:3},{value:"CbiTooLarge",id:"cbitoolarge",level:3},{value:"constructor",id:"constructor",level:3},{value:"Parameters",id:"parameters",level:4},{value:"updateSbCommitment",id:"updatesbcommitment",level:3},{value:"genSubsidyPackedVals",id:"gensubsidypackedvals",level:3},{value:"Parameters",id:"parameters-1",level:4},{value:"Return Values",id:"return-values",level:4},{value:"genSubsidyPublicInputHash",id:"gensubsidypublicinputhash",level:3},{value:"Parameters",id:"parameters-2",level:4},{value:"Return Values",id:"return-values-1",level:4},{value:"updateSubsidy",id:"updatesubsidy",level:3},{value:"Parameters",id:"parameters-3",level:4},{value:"increaseSubsidyIndex",id:"increasesubsidyindex",level:3},{value:"Parameters",id:"parameters-4",level:4},{value:"verifySubsidyProof",id:"verifysubsidyproof",level:3},{value:"Parameters",id:"parameters-5",level:4},{value:"Return Values",id:"return-values-2",level:4}];function h(e){const i={code:"code",em:"em",h1:"h1",h3:"h3",h4:"h4",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,r.a)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(i.h1,{id:"subsidy",children:"Subsidy"}),"\n",(0,n.jsx)(i.p,{children:"This contract is used to verify that the subsidy calculations\nare correct. It is also used to update the subsidy commitment if the\nproof is valid."}),"\n",(0,n.jsx)(i.h3,{id:"rbi",children:"rbi"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"uint256 rbi\n"})}),"\n",(0,n.jsx)(i.h3,{id:"cbi",children:"cbi"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"uint256 cbi\n"})}),"\n",(0,n.jsx)(i.h3,{id:"sbcommitment",children:"sbCommitment"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"uint256 sbCommitment\n"})}),"\n",(0,n.jsx)(i.h3,{id:"subsidycommitment",children:"subsidyCommitment"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"uint256 subsidyCommitment\n"})}),"\n",(0,n.jsx)(i.h3,{id:"verifier",children:"verifier"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"contract IVerifier verifier\n"})}),"\n",(0,n.jsx)(i.h3,{id:"vkregistry",children:"vkRegistry"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"contract IVkRegistry vkRegistry\n"})}),"\n",(0,n.jsx)(i.h3,{id:"poll",children:"poll"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"contract IPoll poll\n"})}),"\n",(0,n.jsx)(i.h3,{id:"mp",children:"mp"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"contract IMessageProcessor mp\n"})}),"\n",(0,n.jsx)(i.h3,{id:"processingnotcomplete",children:"ProcessingNotComplete"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"error ProcessingNotComplete()\n"})}),"\n",(0,n.jsx)(i.h3,{id:"invalidsubsidyproof",children:"InvalidSubsidyProof"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"error InvalidSubsidyProof()\n"})}),"\n",(0,n.jsx)(i.h3,{id:"allsubsidycalculated",children:"AllSubsidyCalculated"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"error AllSubsidyCalculated()\n"})}),"\n",(0,n.jsx)(i.h3,{id:"vknotset",children:"VkNotSet"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"error VkNotSet()\n"})}),"\n",(0,n.jsx)(i.h3,{id:"numsignupstoolarge",children:"NumSignUpsTooLarge"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"error NumSignUpsTooLarge()\n"})}),"\n",(0,n.jsx)(i.h3,{id:"rbitoolarge",children:"RbiTooLarge"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"error RbiTooLarge()\n"})}),"\n",(0,n.jsx)(i.h3,{id:"cbitoolarge",children:"CbiTooLarge"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"error CbiTooLarge()\n"})}),"\n",(0,n.jsx)(i.h3,{id:"constructor",children:"constructor"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"constructor(address _verifier, address _vkRegistry, address _poll, address _mp) public payable\n"})}),"\n",(0,n.jsx)(i.p,{children:"Create a new Subsidy contract"}),"\n",(0,n.jsx)(i.h4,{id:"parameters",children:"Parameters"}),"\n",(0,n.jsxs)(i.table,{children:[(0,n.jsx)(i.thead,{children:(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.th,{children:"Name"}),(0,n.jsx)(i.th,{children:"Type"}),(0,n.jsx)(i.th,{children:"Description"})]})}),(0,n.jsxs)(i.tbody,{children:[(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.td,{children:"_verifier"}),(0,n.jsx)(i.td,{children:"address"}),(0,n.jsx)(i.td,{children:"The Verifier contract"})]}),(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.td,{children:"_vkRegistry"}),(0,n.jsx)(i.td,{children:"address"}),(0,n.jsx)(i.td,{children:"The VkRegistry contract"})]}),(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.td,{children:"_poll"}),(0,n.jsx)(i.td,{children:"address"}),(0,n.jsx)(i.td,{children:"The Poll contract"})]}),(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.td,{children:"_mp"}),(0,n.jsx)(i.td,{children:"address"}),(0,n.jsx)(i.td,{children:"The MessageProcessor contract"})]})]})]}),"\n",(0,n.jsx)(i.h3,{id:"updatesbcommitment",children:"updateSbCommitment"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"function updateSbCommitment() public\n"})}),"\n",(0,n.jsx)(i.p,{children:"Update the currentSbCommitment if the proof is valid."}),"\n",(0,n.jsx)(i.p,{children:(0,n.jsx)(i.em,{children:"currentSbCommitment is the commitment to the state and ballot roots"})}),"\n",(0,n.jsx)(i.h3,{id:"gensubsidypackedvals",children:"genSubsidyPackedVals"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"function genSubsidyPackedVals(uint256 _numSignUps) public view returns (uint256 result)\n"})}),"\n",(0,n.jsx)(i.p,{children:"Generate the packed values for the subsidy proof"}),"\n",(0,n.jsx)(i.h4,{id:"parameters-1",children:"Parameters"}),"\n",(0,n.jsxs)(i.table,{children:[(0,n.jsx)(i.thead,{children:(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.th,{children:"Name"}),(0,n.jsx)(i.th,{children:"Type"}),(0,n.jsx)(i.th,{children:"Description"})]})}),(0,n.jsx)(i.tbody,{children:(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.td,{children:"_numSignUps"}),(0,n.jsx)(i.td,{children:"uint256"}),(0,n.jsx)(i.td,{children:"The number of signups"})]})})]}),"\n",(0,n.jsx)(i.h4,{id:"return-values",children:"Return Values"}),"\n",(0,n.jsxs)(i.table,{children:[(0,n.jsx)(i.thead,{children:(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.th,{children:"Name"}),(0,n.jsx)(i.th,{children:"Type"}),(0,n.jsx)(i.th,{children:"Description"})]})}),(0,n.jsx)(i.tbody,{children:(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.td,{children:"result"}),(0,n.jsx)(i.td,{children:"uint256"}),(0,n.jsx)(i.td,{children:"The packed values"})]})})]}),"\n",(0,n.jsx)(i.h3,{id:"gensubsidypublicinputhash",children:"genSubsidyPublicInputHash"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"function genSubsidyPublicInputHash(uint256 _numSignUps, uint256 _newSubsidyCommitment) public view returns (uint256 inputHash)\n"})}),"\n",(0,n.jsx)(i.p,{children:"Generate the public input hash for the subsidy proof"}),"\n",(0,n.jsx)(i.h4,{id:"parameters-2",children:"Parameters"}),"\n",(0,n.jsxs)(i.table,{children:[(0,n.jsx)(i.thead,{children:(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.th,{children:"Name"}),(0,n.jsx)(i.th,{children:"Type"}),(0,n.jsx)(i.th,{children:"Description"})]})}),(0,n.jsxs)(i.tbody,{children:[(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.td,{children:"_numSignUps"}),(0,n.jsx)(i.td,{children:"uint256"}),(0,n.jsx)(i.td,{children:"The number of signups"})]}),(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.td,{children:"_newSubsidyCommitment"}),(0,n.jsx)(i.td,{children:"uint256"}),(0,n.jsx)(i.td,{children:"The new subsidy commitment"})]})]})]}),"\n",(0,n.jsx)(i.h4,{id:"return-values-1",children:"Return Values"}),"\n",(0,n.jsxs)(i.table,{children:[(0,n.jsx)(i.thead,{children:(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.th,{children:"Name"}),(0,n.jsx)(i.th,{children:"Type"}),(0,n.jsx)(i.th,{children:"Description"})]})}),(0,n.jsx)(i.tbody,{children:(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.td,{children:"inputHash"}),(0,n.jsx)(i.td,{children:"uint256"}),(0,n.jsx)(i.td,{children:"The public input hash"})]})})]}),"\n",(0,n.jsx)(i.h3,{id:"updatesubsidy",children:"updateSubsidy"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"function updateSubsidy(uint256 _newSubsidyCommitment, uint256[8] _proof) external\n"})}),"\n",(0,n.jsx)(i.p,{children:"Update the subsidy commitment if the proof is valid"}),"\n",(0,n.jsx)(i.h4,{id:"parameters-3",children:"Parameters"}),"\n",(0,n.jsxs)(i.table,{children:[(0,n.jsx)(i.thead,{children:(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.th,{children:"Name"}),(0,n.jsx)(i.th,{children:"Type"}),(0,n.jsx)(i.th,{children:"Description"})]})}),(0,n.jsxs)(i.tbody,{children:[(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.td,{children:"_newSubsidyCommitment"}),(0,n.jsx)(i.td,{children:"uint256"}),(0,n.jsx)(i.td,{children:"The new subsidy commitment"})]}),(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.td,{children:"_proof"}),(0,n.jsx)(i.td,{children:"uint256[8]"}),(0,n.jsx)(i.td,{children:"The proof"})]})]})]}),"\n",(0,n.jsx)(i.h3,{id:"increasesubsidyindex",children:"increaseSubsidyIndex"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"function increaseSubsidyIndex(uint256 batchSize, uint256 numLeaves) internal\n"})}),"\n",(0,n.jsx)(i.p,{children:"Increase the subsidy batch index (rbi, cbi) to next,\nit will try to cbi++ if the whole batch can fit into numLeaves\notherwise it will increase row index: rbi++.\nEach batch for subsidy calculation is 2 dimensional: batchSize*batchSize"}),"\n",(0,n.jsx)(i.h4,{id:"parameters-4",children:"Parameters"}),"\n",(0,n.jsxs)(i.table,{children:[(0,n.jsx)(i.thead,{children:(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.th,{children:"Name"}),(0,n.jsx)(i.th,{children:"Type"}),(0,n.jsx)(i.th,{children:"Description"})]})}),(0,n.jsxs)(i.tbody,{children:[(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.td,{children:"batchSize"}),(0,n.jsx)(i.td,{children:"uint256"}),(0,n.jsx)(i.td,{children:"the size of 1 dimensional batch over the signup users"})]}),(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.td,{children:"numLeaves"}),(0,n.jsx)(i.td,{children:"uint256"}),(0,n.jsx)(i.td,{children:"total number of leaves in stateTree, i.e. number of signup users"})]})]})]}),"\n",(0,n.jsx)(i.h3,{id:"verifysubsidyproof",children:"verifySubsidyProof"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-solidity",children:"function verifySubsidyProof(uint256[8] _proof, uint256 _numSignUps, uint256 _newSubsidyCommitment) public view returns (bool isValid)\n"})}),"\n",(0,n.jsx)(i.p,{children:"Verify the subsidy proof using the Groth16 on chain verifier"}),"\n",(0,n.jsx)(i.h4,{id:"parameters-5",children:"Parameters"}),"\n",(0,n.jsxs)(i.table,{children:[(0,n.jsx)(i.thead,{children:(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.th,{children:"Name"}),(0,n.jsx)(i.th,{children:"Type"}),(0,n.jsx)(i.th,{children:"Description"})]})}),(0,n.jsxs)(i.tbody,{children:[(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.td,{children:"_proof"}),(0,n.jsx)(i.td,{children:"uint256[8]"}),(0,n.jsx)(i.td,{children:"The proof"})]}),(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.td,{children:"_numSignUps"}),(0,n.jsx)(i.td,{children:"uint256"}),(0,n.jsx)(i.td,{children:"The number of signups"})]}),(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.td,{children:"_newSubsidyCommitment"}),(0,n.jsx)(i.td,{children:"uint256"}),(0,n.jsx)(i.td,{children:"The new subsidy commitment"})]})]})]}),"\n",(0,n.jsx)(i.h4,{id:"return-values-2",children:"Return Values"}),"\n",(0,n.jsxs)(i.table,{children:[(0,n.jsx)(i.thead,{children:(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.th,{children:"Name"}),(0,n.jsx)(i.th,{children:"Type"}),(0,n.jsx)(i.th,{children:"Description"})]})}),(0,n.jsx)(i.tbody,{children:(0,n.jsxs)(i.tr,{children:[(0,n.jsx)(i.td,{children:"isValid"}),(0,n.jsx)(i.td,{children:"bool"}),(0,n.jsx)(i.td,{children:"True if the proof is valid"})]})})]})]})}function o(e={}){const{wrapper:i}={...(0,r.a)(),...e.components};return i?(0,n.jsx)(i,{...e,children:(0,n.jsx)(h,{...e})}):h(e)}},720:(e,i,s)=>{s.d(i,{Z:()=>l,a:()=>t});var n=s(79);const r={},d=n.createContext(r);function t(e){const i=n.useContext(d);return n.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function l(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),n.createElement(d.Provider,{value:i},e.children)}}}]);